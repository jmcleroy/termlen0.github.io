<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Part1 of a 2 part blog on using the Ansible network-engine's command parser &middot; Network Automation
    
  </title>

  <!-- CSS -->
  <!-- <link rel="stylesheet" href="/public/css/poole.css"> -->
  <!-- <link rel="stylesheet" href="/public/css/syntax.css"> -->
  <!-- <link rel="stylesheet" href="/public/css/hyde.css"> -->
  <!-- <link rel="stylesheet" -->

<link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet"  href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
</head>

  <h3 class="masthead-title">
    <a href="/" title="Home">Network Automation</a>

    
    &nbsp;&nbsp;&nbsp;
    <small><a href="/archive">Archive</a></small>
    
  </h3>
  <body class="theme-base-08">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Network Automation
        </a>
      </h1>
      <p class="lead">Observations in network automation<br /> <a href="https://twitter.com/termlen0" target="_blank">@termlen0</a></p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/acrhive/">Archive</a>
          
        
      
        
      
        
          
        
      
        
      
        
          
        
      
        
          
        
      

            <a class="sidebar-nav-item" href="https://github.com/termlen0">GitHub project</a>

            <a href="https://twitter.com/termlen0"> <i class="fa fa-twitter"></i> </a>
            <a href="https://github.com/termlen0"> <i class="fa fa-github"></i> </a>
            
            <a href="https://linkedin.com/in/achenampara"> <i class="fa fa-linkedin"></i> </a>

    
    </nav>
    
    <p>&copy; 2019. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Part1 of a 2 part blog on using the Ansible network-engine's command parser</h1>
  <span class="post-date">26 Jun 2018</span>
  <h3>A very brief introduction</h3>

<p>The <a href="https://github.com/ansible-network/network-engine/blob/devel/docs/user_guide/README.md">network-engine</a> role was made available through Ansible galaxy recently. One of the modules this role makes available for network engineers, is the <a href="https://github.com/ansible-network/network-engine/blob/devel/docs/user_guide/command_parser.md">command parser</a>. As the name implies, command parser enables the user to parse the output of <em>show</em> commands - commands that network engineers know and love, that are &quot;pretty&quot; formatted but not structured. </p>

<p>Until recently, I had only used <a href="https://github.com/google/textfsm">TextFSM</a> to do this. While TextFSM works, it has a significant learning curve, IMO. Last week I decided to give the <code>command_parser</code> module a spin and right off the bat my impressions were:</p>

<ol>
<li><p>If you are already comfortable using Ansible, you will feel at home working with the command parser</p></li>
<li><p>The learning curve is much shorter without needing to worry about learning another domain specific language</p></li>
</ol>

<blockquote>
<p>Note: This is in no way pitting one against the other. <strong>network-engine</strong> provides a <strong>textfsm_parser</strong> as well as the <strong>command_parser</strong></p>
</blockquote>

<!--more-->

<p>My intention through the 2 part blog, is to write about how to build command parser templates using 2 examples. I hope it will help others and will serve as a reference when I need it later.</p>

<p>However, first thing first - The official documentation is available here: <a href="https://github.com/ansible-network/network-engine/blob/devel/docs/directives/parser_directives.md">command parser directives</a></p>

<h3>Diving in: parsing the output of <code>show ip interfaces brief</code> on a Cisco IOS device</h3>

<p>Rather than reiterate what is in the documentation, lets dive in with an example. We&#39;ll start off with the playbook that captures the output of the <code>show ip interfaces brief</code> command.</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">GENERATE A REPORT</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cisco</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">network_cli</span>

  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ansible-network.network-engine</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">CAPTURE SHOW IP INTERFACE</span>
    <span class="l l-Scalar l-Scalar-Plain">ios_command</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">show ip interface brief</span>
    <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">output</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DISPLAY THE OUTPUT</span>
    <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">var=output.stdout</span>
</code></pre></div>
<p>This should hopefully look familiar to folks who are used to using Ansible for working with network devices. Pay attention to the </p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span>  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ansible-network.network-engine</span>
</code></pre></div>
<p>This is the role that provides the <code>command_parser</code> library that we will be working with. This role can be downloaded and installed as per instructions in the links above.</p>

<p>On running the playbook (and limiting it to a single device):</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>PLAY <span class="o">[</span>GENERATE A REPORT <span class="o">]</span> ***************************************************************************

TASK <span class="o">[</span>CAPTURE SHOW IP INTERFACE<span class="o">]</span> ****************************************************************************
ok: <span class="o">[</span>rtr1<span class="o">]</span>

TASK <span class="o">[</span>DISPLAY THE OUTPUT<span class="o">]</span> *****************************************************************************************************************************************************************************************
ok: <span class="o">[</span>rtr1<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&quot;output.stdout&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;Interface              IP-Address      OK? Method Status                Protocol\nGigabitEthernet1       172.16.244.50   YES DHCP   up                    up      \nLoopback0              192.168.1.101   YES manual up                    up      \nLoopback1              10.1.1.101      YES manual administratively down down    \nTunnel0                10.100.100.1    YES manual up                    up      \nTunnel1                10.200.200.1    YES manual up                    up      \nVirtualPortGroup0      192.168.35.101  YES TFTP   up                    up&quot;</span>
    <span class="o">]</span>
<span class="o">}</span>

PLAY RECAP ********************************************************************************************************************************************************************************************************
rtr1                       : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>  
</code></pre></div>
<p>So far so good. We got the output of the show command. Now we can send this &quot;blob&quot; of text to a command parser that can create structured data from it.</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DYNAMIC REPORTING PART</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cisco</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">network_cli</span>

  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ansible-network.network-engine</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">CAPTURE SHOW IP INTERFACE</span>
    <span class="l l-Scalar l-Scalar-Plain">ios_command</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">show ip interface brief</span>
    <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">output</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DISPLAY THE OUTPUT</span>
    <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">var=output.stdout</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PARSE THE RAW OUTPUT</span>
    <span class="l l-Scalar l-Scalar-Plain">command_parser</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">file</span><span class="p p-Indicator">:</span> <span class="s">&quot;parsers/ios/show_ip_interface_brief.yaml&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">content</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">output.stdout[0]</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<p>Now, we get into the meat of this blog. Using the <code>command_parser</code> module. </p>

<h3>Writing our first parser</h3>

<p>This is my workflow for creating a new parser:</p>

<ol>
<li><p>Identify the regular expression/expressions needed to collect the data using regex101.com</p></li>
<li><p>Use the <a href="https://github.com/ansible-network/network-engine/blob/devel/docs/directives/parser_directives.md">parser directives</a> to test out the regular expression</p></li>
<li><p>Iterate and refine</p></li>
</ol>

<p>So let&#39;s begin with creating the regular expression. Let&#39;s say we want to capture the <em>Interface name, IP address, Admin state and Protocol State</em> . The following regular expression is what I came up with:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>^(\\S+)\\s+(\\d+\\.\\d+\\.\\d+\\.\\d+).*(up|administratively down).*(up|down)
</code></pre></div>
<p>On to step 2 testing this. The parser file defined by </p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span>      <span class="l l-Scalar l-Scalar-Plain">file</span><span class="p p-Indicator">:</span> <span class="s">&quot;parsers/ios/show_ip_interface_brief.yaml&quot;</span>
</code></pre></div>
<p>is a YAML file. </p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PARSER META DATA</span>
  <span class="l l-Scalar l-Scalar-Plain">parser_metadata</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">show ip interface brief</span>
    <span class="l l-Scalar l-Scalar-Plain">network_os</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ios</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">MATCH PATTERN</span>
  <span class="l l-Scalar l-Scalar-Plain">pattern_match</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">regex</span><span class="p p-Indicator">:</span> <span class="s">&quot;^(\\S+)\\s+(\\d+\\.\\d+\\.\\d+\\.\\d+).*(up|administratively</span><span class="nv"> </span><span class="s">down).*(up|down)&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">match_all</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">section</span>
  <span class="l l-Scalar l-Scalar-Plain">export</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div>
<p>Here we are using the <code>pattern_match</code> directive. The regex is now applied to the blob of input passed in from the playbook task. The match groups are collected and stored into the variable called <code>section</code>. We use the <code>match_all</code> option in order to match all the capture groups.</p>

<p>Note the use of the <code>export: yes</code>. Without this directive the variable and value contained will not be sent back to the playbook for further processing. </p>

<blockquote>
<p>As part of our development of the parser we might have to use the <code>export: yes</code> at multiple stages.</p>
</blockquote>

<p>In order to test this, re-run the playbook but in <code>verbose</code> mode:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>TASK <span class="o">[</span>PARSE THE RAW OUTPUT<span class="o">]</span> ***************************************************************************************************************************************************************************************
ok: <span class="o">[</span>rtr1<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span><span class="s2">&quot;ansible_facts&quot;</span>: <span class="o">{</span><span class="s2">&quot;section&quot;</span>: <span class="o">[{</span><span class="s2">&quot;matches&quot;</span>: <span class="o">[</span><span class="s2">&quot;GigabitEthernet1&quot;</span>, <span class="s2">&quot;172.16.244.50&quot;</span>, <span class="s2">&quot;up&quot;</span>, <span class="s2">&quot;up&quot;</span><span class="o">]}</span>, <span class="o">{</span><span class="s2">&quot;matches&quot;</span>: <span class="o">[</span><span class="s2">&quot;Loopback0&quot;</span>, <span class="s2">&quot;192.168.1.101&quot;</span>, <span class="s2">&quot;up&quot;</span>, <span class="s2">&quot;up&quot;</span><span class="o">]}</span>, <span class="o">{</span><span class="s2">&quot;matches&quot;</span>: <span class="o">[</span><span class="s2">&quot;Loopback1&quot;</span>, <span class="s2">&quot;10.1.1.101&quot;</span>, <span class="s2">&quot;administratively down&quot;</span>, <span class="s2">&quot;down&quot;</span><span class="o">]}</span>, <span class="o">{</span><span class="s2">&quot;matches&quot;</span>: <span class="o">[</span><span class="s2">&quot;Tunnel0&quot;</span>, <span class="s2">&quot;10.100.100.1&quot;</span>, <span class="s2">&quot;up&quot;</span>, <span class="s2">&quot;up&quot;</span><span class="o">]}</span>, <span class="o">{</span><span class="s2">&quot;matches&quot;</span>: <span class="o">[</span><span class="s2">&quot;Tunnel1&quot;</span>, <span class="s2">&quot;10.200.200.1&quot;</span>, <span class="s2">&quot;up&quot;</span>, <span class="s2">&quot;up&quot;</span><span class="o">]}</span>, <span class="o">{</span><span class="s2">&quot;matches&quot;</span>: <span class="o">[</span><span class="s2">&quot;VirtualPortGroup0&quot;</span>, <span class="s2">&quot;192.168.35.101&quot;</span>, <span class="s2">&quot;up&quot;</span>, <span class="s2">&quot;up&quot;</span><span class="o">]}]}</span>, <span class="s2">&quot;changed&quot;</span>: false, <span class="s2">&quot;included&quot;</span>: <span class="o">[</span><span class="s2">&quot;parsers/ios/show_ip_interface_brief.yaml&quot;</span><span class="o">]}</span>

PLAY RECAP ********************************************************************************************************************************************************************************************************
rtr1                       : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>   
</code></pre></div>
<p>Great! We can already see the data being returned as list of dictionaries. Now within the command parser you have the option of cleaning up and presenting this data as a structured <code>json</code> object. Let&#39;s do that as the next step using the <code>json_template</code> directive:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PARSER META DATA</span>
  <span class="l l-Scalar l-Scalar-Plain">parser_metadata</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">show ip interface brief</span>
    <span class="l l-Scalar l-Scalar-Plain">network_os</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ios</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">MATCH PATTERN</span>
  <span class="l l-Scalar l-Scalar-Plain">pattern_match</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">regex</span><span class="p p-Indicator">:</span> <span class="s">&quot;^(\\S+)\\s+(\\d+\\.\\d+\\.\\d+\\.\\d+).*(up|administratively</span><span class="nv"> </span><span class="s">down).*(up|down)&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">match_all</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">section</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">GENERATE JSON DATA STRUCTURE</span>
  <span class="l l-Scalar l-Scalar-Plain">json_template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.matches.0</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">object</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">data</span>
          <span class="l l-Scalar l-Scalar-Plain">object</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">name</span>
              <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.matches.0</span><span class="nv"> </span><span class="s">}}&quot;</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ip</span>
              <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.matches.1</span><span class="nv"> </span><span class="s">}}&quot;</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">admin_state</span>
              <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.matches.2</span><span class="nv"> </span><span class="s">}}&quot;</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">protocol_state</span>
              <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.matches.3</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">loop</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">section</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">export</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ip_interface_facts</span>
</code></pre></div>
<p>The previous match was registered into a variable called <code>section</code>. This is a list as seen from the verbose output above. This list can be looped over to work on individual elements using the <code>loop</code> directive. The <code>json_template</code> directive is used to define a nested dictionary with the key of each element being the name of the interface in this example.</p>

<blockquote>
<p>Note: The <strong>export: yes</strong> has been moved from the <strong>section</strong> variable to the <strong>ip<em>interface</em>facts</strong> variable. </p>
</blockquote>

<p>Once exported the variable becomes available within the playbook and can be used just like any other variable in Ansible. Let&#39;s go ahead and display this using <code>debug</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DYNAMIC REPORTING PART</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cisco</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="l l-Scalar l-Scalar-Plain">connection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">network_cli</span>

  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ansible-network.network-engine</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">CAPTURE SHOW IP ROUTE</span>
    <span class="l l-Scalar l-Scalar-Plain">ios_command</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">commands</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">show ip interface brief</span>
    <span class="l l-Scalar l-Scalar-Plain">register</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">output</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PARSE THE RAW OUTPUT</span>
    <span class="l l-Scalar l-Scalar-Plain">command_parser</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">file</span><span class="p p-Indicator">:</span> <span class="s">&quot;parsers/ios/show_ip_interface_brief.yaml&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">content</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">output.stdout[0]</span><span class="nv"> </span><span class="s">}}&quot;</span>

  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DISPLAY THE DATA</span>
    <span class="l l-Scalar l-Scalar-Plain">debug</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">var=ip_interface_facts</span>
</code></pre></div>
<p>Now when we run the playbook:</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell"><span></span>TASK <span class="o">[</span>DISPLAY THE DATA<span class="o">]</span> *******************************************************************************************************************************************************************************************
ok: <span class="o">[</span>rtr1<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&quot;ip_interface_facts&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;GigabitEthernet1&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;data&quot;</span>: <span class="o">{</span>
                    <span class="s2">&quot;admin_state&quot;</span>: <span class="s2">&quot;up&quot;</span>, 
                    <span class="s2">&quot;ip&quot;</span>: <span class="s2">&quot;172.16.244.50&quot;</span>, 
                    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;GigabitEthernet1&quot;</span>, 
                    <span class="s2">&quot;protocol_state&quot;</span>: <span class="s2">&quot;up&quot;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>, 
        <span class="o">{</span>
            <span class="s2">&quot;Loopback0&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;data&quot;</span>: <span class="o">{</span>
                    <span class="s2">&quot;admin_state&quot;</span>: <span class="s2">&quot;up&quot;</span>, 
                    <span class="s2">&quot;ip&quot;</span>: <span class="s2">&quot;192.168.1.101&quot;</span>, 
                    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Loopback0&quot;</span>, 
                    <span class="s2">&quot;protocol_state&quot;</span>: <span class="s2">&quot;up&quot;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>, 
        <span class="o">{</span>
            <span class="s2">&quot;Loopback1&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;data&quot;</span>: <span class="o">{</span>
                    <span class="s2">&quot;admin_state&quot;</span>: <span class="s2">&quot;administratively down&quot;</span>, 
                    <span class="s2">&quot;ip&quot;</span>: <span class="s2">&quot;10.1.1.101&quot;</span>, 
                    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Loopback1&quot;</span>, 
                    <span class="s2">&quot;protocol_state&quot;</span>: <span class="s2">&quot;down&quot;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>, 
        <span class="o">{</span>
            <span class="s2">&quot;Tunnel0&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;data&quot;</span>: <span class="o">{</span>
                    <span class="s2">&quot;admin_state&quot;</span>: <span class="s2">&quot;up&quot;</span>, 
                    <span class="s2">&quot;ip&quot;</span>: <span class="s2">&quot;10.100.100.1&quot;</span>, 
                    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Tunnel0&quot;</span>, 
.
.
.
.
.
&lt;output omitted <span class="k">for</span> brevity&gt;
</code></pre></div>
<p>Now, wasn&#39;t that easy!! At least I think it was a lot easier to work with personally than TextFSM. </p>

<p>In part 2 of the blog series we will build a command parser for the <code>show interfaces</code> command on IOS devices. This will be a little more complex than the example in part 1 and will hopefully help demonstrate how really powerful the <code>command_parser</code> module is.</p>

<p><em>Twitter:</em> <a href="https://twitter.com/intent/tweet?url=http://localhost:4000/2018/06/26/observations/&text=Part1 of a 2 part blog on using the Ansible network-engine's command parser&via=termlen0" 
   target="_blank"> Share it with your followers</a> 
or 
<a href="https://twitter.com/termlen0">
  Follow me on Twitter</a>!</p>

</div>
<a href="https://twitter.com/share" class="twitter-share-button"
data-via="termlen0">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2019/06/08/observations/">
            Custom credentials in Ansible Tower to store Github private keys
            <small>08 Jun 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/30/observations/">
            Using Ansible network-engine to simplify network automation tasks
            <small>30 Jul 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2018/07/15/observations/">
            Part2 of a 2 part blog on using the Ansible network-engine's command parser
            <small>15 Jul 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//https-termlen0-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                                

    </div>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-121410364-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-121410364-1');
</script>


  </body>
</html>
